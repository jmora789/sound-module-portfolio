<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Sound Canvas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Barlow+Light:wght@300&display=swap" rel="stylesheet">
    <!-- Tone.js for the interactive sound elements -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.js"></script>
    <style>
        body {
            background-color: #1a202c;
            color: #e2e8f0;
            font-family: 'Barlow Light', sans-serif;
        }
        h1, h2 {
            font-family: 'Oswald', sans-serif;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 md:p-8">

    <div class="w-full max-w-2xl bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-white mb-2">Sound and Silence</h1>
            <p class="text-gray-400">A John Cage-inspired sound exploration.</p>
        </header>

        <!-- Recording Section -->
        <section class="mb-8 p-6 bg-gray-700 rounded-xl">
            <h2 class="text-lg font-semibold uppercase mb-4 text-white text-center">Record Your Moment</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="recordButton" class="w-full sm:w-auto px-6 py-3 bg-[#e91d63] text-white font-light rounded-xl shadow-lg transition-transform transform hover:scale-105 uppercase">
                    Record
                </button>
                <button id="stopButton" class="hidden w-full sm:w-auto px-6 py-3 bg-rose-600 text-white font-light rounded-xl shadow-lg transition-transform transform hover:scale-105 uppercase">
                    Stop
                </button>
            </div>
            <p id="messageArea" class="mt-4 text-center text-gray-300 min-h-[1.5rem]"></p>
            <div id="downloadContainer" class="mt-4 hidden flex justify-center">
                <a id="downloadLink" href="#" download="my_audio.webm" class="px-6 py-3 bg-sky-500 text-white font-light rounded-xl shadow-lg transition-transform transform hover:scale-105 uppercase">
                    Download Recording
                </a>
            </div>
        </section>

        <!-- Sound Interaction Section -->
        <section class="p-6 bg-gray-700 rounded-xl">
            <h2 class="text-lg font-semibold uppercase mb-4 text-white text-center">Interactive Sounds</h2>
            <p class="text-gray-300 mb-6">Click the buttons below to generate a new sound, or just listen to the silence.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <button id="button1" class="w-full py-3 bg-fuchsia-500 text-white font-light rounded-xl shadow-lg transition-transform transform hover:scale-105 uppercase">
                    Generate<br>Random Note
                </button>
                <button id="button2" class="w-full py-3 bg-cyan-500 text-white font-light rounded-xl shadow-lg transition-transform transform hover:scale-105 uppercase">
                    Play<br>White Noise
                </button>
                <button id="button3" class="w-full py-3 bg-amber-500 text-white font-light rounded-xl shadow-lg transition-transform transform hover:scale-105 uppercase">
                    Toggle Drone
                </button>
            </div>
        </section>
    </div>

    <script>
        // --- Tone.js Sound Logic ---
        const synth = new Tone.Synth().toDestination();
        const noise = new Tone.Noise('pink').toDestination();
        const droneSynth = new Tone.DuoSynth().toDestination();
        const drone = new Tone.Loop(time => {
            droneSynth.triggerAttackRelease("C3", "8n", time);
        }, "1n");

        document.getElementById('button1').addEventListener('click', () => {
            const notes = ["C4", "E4", "G4", "A4", "B4"];
            const note = notes[Math.floor(Math.random() * notes.length)];
            synth.triggerAttackRelease(note, "8n");
        });

        document.getElementById('button2').addEventListener('click', () => {
            if (noise.state === 'started') {
                noise.stop();
            } else {
                noise.start();
            }
        });

        document.getElementById('button3').addEventListener('click', () => {
            // First, start the main Tone.js transport if it's not running
            if (Tone.Transport.state !== 'started') {
                Tone.Transport.start();
            }
            // Then, toggle the drone loop on or off
            if (drone.state === 'started') {
                drone.stop();
            } else {
                drone.start();
            }
        });

        // --- Audio Recording Logic ---
        let mediaRecorder;
        let audioChunks = [];
        let audioStream;

        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const messageArea = document.getElementById('messageArea');
        const downloadLink = document.getElementById('downloadLink');
        const downloadContainer = document.getElementById('downloadContainer');

        // Check for MediaRecorder support
        if (!navigator.mediaDevices || !window.MediaRecorder) {
            messageArea.textContent = "Your browser does not support audio recording.";
            recordButton.disabled = true;
        }

        recordButton.addEventListener('click', async () => {
            try {
                messageArea.textContent = "Requesting microphone permission...";
                // Request microphone access
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                messageArea.textContent = "Recording...";
                recordButton.classList.add('hidden');
                stopButton.classList.remove('hidden');
                downloadContainer.classList.add('hidden');
                console.log("Microphone access granted. Starting MediaRecorder.");

                // Initialize MediaRecorder
                mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm' });
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    console.log("Data available:", event.data);
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    console.log("MediaRecorder stopped.");
                    if (audioChunks.length === 0) {
                        messageArea.textContent = "Recording failed. No audio data was captured.";
                        console.error("No audio data was captured.");
                        return;
                    }
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    downloadLink.href = audioUrl;
                    downloadContainer.classList.remove('hidden');
                    messageArea.textContent = "Recording complete! Click to download.";
                    console.log("Recording successfully processed.");

                    // Stop the stream tracks to release the microphone
                    audioStream.getTracks().forEach(track => {
                        console.log("Stopping audio track:", track);
                        track.stop();
                    });
                };
                
                mediaRecorder.start();
                console.log("MediaRecorder started.");

            } catch (err) {
                console.error("Error accessing microphone:", err);
                messageArea.textContent = "Error: Could not access microphone. Please check your browser permissions.";
                recordButton.classList.remove('hidden');
                stopButton.classList.add('hidden');
            }
        });

        stopButton.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                console.log("Stopping MediaRecorder.");
                mediaRecorder.stop();
                messageArea.textContent = "Processing recording...";
                stopButton.classList.add('hidden');
                recordButton.classList.remove('hidden');
            }
        });

    </script>
</body>
</html>
